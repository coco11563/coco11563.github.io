name: ğŸ“Š Update Scholar Data

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹æ‰§è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ•°æ®'
        required: false
        default: false
        type: boolean
  push:
    paths:
      # å½“æ•°æ®è„šæœ¬å˜æ›´æ—¶è§¦å‘
      - 'scripts/**'
      - '.github/workflows/update-data.yml'

# è®¾ç½®æƒé™
permissions:
  contents: write
  actions: read

jobs:
  update-scholar-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        # å¦‚æœæ²¡æœ‰ package-lock.jsonï¼Œä½¿ç”¨ npm install
        if [ ! -f "package-lock.json" ]; then
          echo "âš ï¸  package-lock.json not found, using npm install"
          npm install
        else
          npm ci
        fi
        # å®‰è£…æ•°æ®é‡‡é›†æ‰€éœ€çš„å¯é€‰ä¾èµ–
        npm install serpapi || echo "SerpAPI installation failed, using fallback"
    
    - name: ğŸ” Fetch latest scholar data
      run: |
        echo "ğŸš€ å¼€å§‹è·å–å­¦æœ¯æ•°æ®..."
        echo "ğŸ“‹ å½“å‰é…ç½®:"
        echo "  - Scholar ID: ${SCHOLAR_ID}"
        echo "  - SerpAPIé…ç½®: $([ -n "$SERPAPI_KEY" ] && echo "å·²é…ç½®" || echo "æœªé…ç½®ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ•°æ®æº")"
        
        # å¤‡ä»½ç°æœ‰æ•°æ®ä»¥é˜²å‡ºé”™
        if [ -f "public/data/publications.json" ]; then
          echo "ğŸ’¾ å¤‡ä»½ç°æœ‰æ•°æ®..."
          cp public/data/publications.json public/data/publications.json.backup || true
          cp public/data/selected-publications.json public/data/selected-publications.json.backup || true
        fi
        
        # æ‰§è¡Œæ•°æ®è·å–
        node scripts/fetch-scholar-data.js
        
        echo "âœ… å­¦æœ¯æ•°æ®è·å–å®Œæˆ"
      env:
        SCHOLAR_ID: 'YGwukbUAAAAJ'
        SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
    
    - name: ğŸ“Š Analyze data changes
      id: check-changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if [ -n "$(git status --porcelain public/data/)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ˆ æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
          
          # ç”Ÿæˆå˜æ›´æ‘˜è¦
          git diff --name-only public/data/ > changes.txt
          echo "Changed files:"
          cat changes.txt
          
          # åˆ†æå¼•ç”¨æ•°å˜åŒ–
          if [ -f "public/data/publications.json.backup" ] && [ -f "public/data/publications.json" ]; then
            echo "ğŸ“ˆ åˆ†æå¼•ç”¨æ•°å˜åŒ–..."
            
            # ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼æ¯”è¾ƒå¼•ç”¨æ•°å˜åŒ–
            old_total=$(cat public/data/publications.json.backup | grep -o '"citations": *[0-9]*' | awk -F': *' '{sum += $2} END {print sum+0}')
            new_total=$(cat public/data/publications.json | grep -o '"citations": *[0-9]*' | awk -F': *' '{sum += $2} END {print sum+0}')
            
            if [ "$old_total" != "$new_total" ]; then
              diff=$((new_total - old_total))
              echo "ğŸ“Š æ€»å¼•ç”¨æ•°å˜åŒ–: $old_total â†’ $new_total (+$diff)"
            else
              echo "ğŸ“‹ æ€»å¼•ç”¨æ•°æ— å˜åŒ–: $new_total"
            fi
          fi
          
          # æ£€æŸ¥å…³é”®æŒ‡æ ‡å˜åŒ–
          if [ -f "public/data/metrics.json" ]; then
            echo "ğŸ“Š å½“å‰æŒ‡æ ‡:"
            cat public/data/metrics.json | grep -E '"(totalCitations|hIndex)"'
          fi
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ•°æ®æ— å˜åŒ–"
        fi
    
    - name: ğŸ·ï¸ Generate commit message
      if: steps.check-changes.outputs.changes == 'true'
      id: commit-msg
      run: |
        # ç”ŸæˆåŠ¨æ€æäº¤ä¿¡æ¯
        current_date=$(date -u +"%Y-%m-%d %H:%M UTC")
        
        # ä»metrics.jsonè¯»å–å½“å‰æ•°æ®
        if [ -f "public/data/metrics.json" ]; then
          citations=$(cat public/data/metrics.json | grep '"totalCitations"' | sed 's/.*: *\([0-9]*\).*/\1/')
          h_index=$(cat public/data/metrics.json | grep '"hIndex"' | sed 's/.*: *\([0-9]*\).*/\1/')  
          pub_count=$(cat public/data/publications.json | grep -c '"id":')
          
          # è®¡ç®—å¼•ç”¨æ•°å˜åŒ–
          citation_change=""
          if [ -f "public/data/publications.json.backup" ]; then
            old_total=$(cat public/data/publications.json.backup | grep -o '"citations": *[0-9]*' | awk -F': *' '{sum += $2} END {print sum+0}')
            new_total=$(cat public/data/publications.json | grep -o '"citations": *[0-9]*' | awk -F': *' '{sum += $2} END {print sum+0}')
            if [ "$old_total" != "$new_total" ]; then
              diff=$((new_total - old_total))
              citation_change=" (+${diff} æ–°å¢å¼•ç”¨)"
            fi
          fi
          
          commit_message=$(cat <<EOF
        ğŸ“Š è‡ªåŠ¨æ›´æ–°å­¦æœ¯æ•°æ® ${current_date}

        ğŸ“ˆ å½“å‰ç»Ÿè®¡:
        - æ€»å¼•ç”¨æ•°: ${citations}${citation_change}
        - HæŒ‡æ•°: ${h_index} 
        - è®ºæ–‡æ•°é‡: ${pub_count}

        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        )
        else
          commit_message=$(cat <<EOF
        ğŸ“Š è‡ªåŠ¨æ›´æ–°å­¦æœ¯æ•°æ® ${current_date}

        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        )
        fi
        
        echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_OUTPUT
        echo "$commit_message" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ’¾ Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        # é…ç½®Gitç”¨æˆ·
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # é…ç½®Gitä½¿ç”¨tokenè¿›è¡Œè®¤è¯
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
        # æ·»åŠ æ•°æ®æ–‡ä»¶
        git add public/data/
        
        # æäº¤å˜æ›´
        git commit -m "${{ steps.commit-msg.outputs.COMMIT_MESSAGE }}"
        
        # æ¨é€åˆ°è¿œç¨‹
        git push origin main
        
        echo "âœ… æ•°æ®æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"
        
        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f public/data/*.backup
        echo "ğŸ§¹ æ¸…ç†å¤‡ä»½æ–‡ä»¶å®Œæˆ"
    
    - name: ğŸš€ Trigger deployment
      if: steps.check-changes.outputs.changes == 'true'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: data-updated
        client-payload: |
          {
            "timestamp": "${{ steps.commit-msg.outputs.timestamp }}",
            "triggered_by": "scheduled-update"
          }
    
    - name: ğŸ“„ Create update summary
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "## ğŸ“Š å­¦æœ¯æ•°æ®æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ›´æ–°æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "public/data/metrics.json" ]; then
          echo "**å½“å‰æŒ‡æ ‡:**" >> $GITHUB_STEP_SUMMARY
          citations=$(cat public/data/metrics.json | grep '"totalCitations"' | sed 's/.*: *\([0-9]*\).*/\1/')
          h_index=$(cat public/data/metrics.json | grep '"hIndex"' | sed 's/.*: *\([0-9]*\).*/\1/')
          echo "- æ€»å¼•ç”¨æ•°: ${citations}" >> $GITHUB_STEP_SUMMARY
          echo "- HæŒ‡æ•°: ${h_index}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å˜æ›´æ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
        git diff --name-only HEAD~1 HEAD public/data/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ“ No changes summary
      if: steps.check-changes.outputs.changes == 'false'
      run: |
        echo "## ğŸ“‹ å­¦æœ¯æ•°æ®æ£€æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**ç»“æœ:** æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "public/data/update-log.json" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¬¡æ›´æ–°:** $(cat public/data/update-log.json | grep timestamp | sed 's/.*": *"\([^"]*\)".*/\1/')" >> $GITHUB_STEP_SUMMARY
        fi