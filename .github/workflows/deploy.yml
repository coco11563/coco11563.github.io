name: ðŸš€ Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'LICENSE'
  repository_dispatch:
    types: [ data-updated ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: false
        default: 'production'
        type: choice
        options:
        - production
        - staging

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“„ Setup Pages
      uses: actions/configure-pages@v4
      with:
        static_site_generator: next
    
    - name: ðŸ“¦ Install dependencies
      run: |
        npm ci
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: ðŸ” Verify data files
      run: |
        echo "ðŸ“Š æ£€æŸ¥æ•°æ®æ–‡ä»¶..."
        if [ -d "public/data" ]; then
          echo "âœ… æ•°æ®ç›®å½•å­˜åœ¨"
          ls -la public/data/
          
          # éªŒè¯å…³é”®æ•°æ®æ–‡ä»¶
          required_files=("scholar-profile.json" "metrics.json" "publications.json")
          for file in "${required_files[@]}"; do
            if [ -f "public/data/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âš ï¸  $file ç¼ºå¤±ï¼Œç”Ÿæˆé»˜è®¤æ•°æ®"
              npm run fetch-data
              break
            fi
          done
        else
          echo "âš ï¸  æ•°æ®ç›®å½•ä¸å­˜åœ¨ï¼Œç”Ÿæˆåˆå§‹æ•°æ®"
          npm run fetch-data
        fi
    
    - name: ðŸ”¨ Build with Next.js
      run: |
        echo "ðŸ—ï¸  å¼€å§‹æž„å»ºç½‘ç«™..."
        npm run build
        echo "âœ… æž„å»ºå®Œæˆ"
      env:
        NODE_ENV: production
        NEXT_TELEMETRY_DISABLED: 1
    
    - name: ðŸ”§ Post-build optimizations
      run: |
        echo "âš¡ æ‰§è¡Œæž„å»ºåŽä¼˜åŒ–..."
        
        # æ·»åŠ  .nojekyll æ–‡ä»¶ï¼ˆç¦ç”¨ Jekyllï¼‰
        touch out/.nojekyll
        echo "âœ… å·²ç¦ç”¨ Jekyll"
        
        # åˆ›å»º 404 é¡µé¢ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        if [ ! -f "out/404.html" ] && [ -f "out/index.html" ]; then
          cp out/index.html out/404.html
          echo "âœ… å·²åˆ›å»º 404 é¡µé¢"
        fi
        
        # æ·»åŠ å®‰å…¨æ ‡å¤´ï¼ˆé€šè¿‡ _headers æ–‡ä»¶ï¼‰
        cat > out/_headers << 'EOF'
        /*
          X-Frame-Options: DENY
          X-Content-Type-Options: nosniff
          X-XSS-Protection: 1; mode=block
          Referrer-Policy: strict-origin-when-cross-origin
        EOF
        echo "âœ… å·²æ·»åŠ å®‰å…¨æ ‡å¤´"
        
        # ç”Ÿæˆç½‘ç«™åœ°å›¾æ—¶é—´æˆ³
        if [ -f "out/sitemap.xml" ]; then
          sed -i "s/{{TIMESTAMP}}/$(date -u +%Y-%m-%dT%H:%M:%S+00:00)/g" out/sitemap.xml || true
          echo "âœ… å·²æ›´æ–°ç½‘ç«™åœ°å›¾æ—¶é—´æˆ³"
        fi
        
        echo "ðŸ“ æž„å»ºè¾“å‡ºå¤§å°: $(du -sh out | cut -f1)"
    
    - name: ðŸ“Š Build analysis
      run: |
        echo "## ðŸ—ï¸ æž„å»ºåˆ†æžæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºæ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**è¾“å‡ºå¤§å°:** $(du -sh out | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "**æ–‡ä»¶æ•°é‡:** $(find out -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "**ä¸»è¦æ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
        find out -name "*.html" -o -name "*.js" -o -name "*.css" | head -10 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å…³é”®é¡µé¢
        if [ -f "out/index.html" ]; then
          echo "âœ… ä¸»é¡µæž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ä¸»é¡µæž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ðŸ“ Deployment summary
      run: |
        echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç½‘ç«™åœ°å€:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**éƒ¨ç½²æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒŸ ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pages!" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: ðŸ“Š Create deployment report
      if: needs.deploy.result == 'success'
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²æˆåŠŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… è‚–æ¿›å­¦æœ¯ä¸»é¡µå·²æˆåŠŸæ›´æ–°ï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è®¿é—®é“¾æŽ¥:** [ç‚¹å‡»è®¿é—®](https://coco11563.github.io)" >> $GITHUB_STEP_SUMMARY
        echo "**æ›´æ–°æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
    
    - name: âŒ Create failure report
      if: needs.deploy.result == 'failure'
      run: |
        echo "## âŒ éƒ¨ç½²å¤±è´¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºæˆ–éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å¤±è´¥æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY